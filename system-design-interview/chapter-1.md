
한 명의 사용자부터 몇 백만의 사용자를 지원하는 시스템까지 설계 해 볼 것이다. 규모 확장성과 관계된 설계 문제를 푸는 데 유용할 것이다.

### 단일 서버

모든 컴포넌트가 단 한 대의 서버에서 실행되는 간단한 시스템부터 설계해 보자. 웹 앱, 데이터베이스, 캐시 등이 모두 한 서버에서 실행된다.

이 때 사용자 요청 처리 흐름은 다음과 같다.
1. 사용자는 도메인 이름을 이용해 웹사이트에 접속한다.
2. DNS 에 질의하여 도메인 이름을 IP 주소로 변환한다.
3. 해당 IP 주소로 HTTP 요청이 전달된다.
4. 요청을 받은 웹 서버는 HTML 페이지나 JSON 형태의 응답을 반환한다.

### 데이터베이스

사용자가 늘면 서버 하나로는 충분하지 않아서 여러 서버를 두어야 한다. 하나는 사용자 요청 트래픽 처리 용도고, 다른 하나는 데이터베이스 용이다.

웹 계층과 데이터 계층을 분리하면 그 각각을 독립적으로 확장해 나갈 수 있다.

데이터베이스는 관계형 데이터베이스와 비-관계형 데이터베이스 사이에서 고를 수 있다.

대부분의 경우엔 관계형 데이터베이스가 최선이다. 40년 이상 시장에서 살아남아 잘 사용되어 온 시스템이라서다.

그럼에도 다음과 같은 경우에는 비-관계형 데이터베이스가 바람직한 선택일 수 있다.
- 아주 낮은 응답 지연시간이 요구됨
- 데이터가 비정형임
- 데이터를 직렬화 또는 역직렬화 할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장 해야 함


### 수직적 규모 확장 vs 수평적 규모 확장

스케일 업이라고도 하는 수직적 규모 확장은 서버에 고사양 자원을 추가하는 것을 말한다. 반면 스케일 아웃이라고도 하는 수평적 규모 확장은 더 많은 서버를 추가해 성능을 개선하는 것을 말한다.

수직적 확장은 단순하다는 장점이 있지만 몇 가지 심각한 단점이 있다.
- 한계가 있다. 서버 한 대의 자원을 무한대로 증설할 수는 없다.
- 서버에 장애가 발생하면 서비스는 완전히 중단된다.

앞서 본 설계에서 사용자는 웹 서버에 바로 연결된다. 너무 많은 사용자가 접속 해 웹 서버가 한계 상황에 도달하면 응답 속도가 느려지거나 서버가 다운 될 수도 있다.

수평적 규모 확장와 로드밸런서를 도입 해 이런 문제를 해결할 수 있다.


**로드밸런서**

로드밸런서는 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 한다. 구체적으로 살펴보면 다음과 같다.

1. 사용자는 로드밸런서의 IP 주소로 접속한다. 로드밸런서는 트래픽을 웹 서버에 분산하고 웹 서버는 사용자 요청을 처리한다. 
2. 만약 서버 하나가 다운되면 모든 트래픽은 나머지 서버들에게 분산된다. 따라서 웹 사이트 전체가 다운되는 일이 방지된다.
3. 트래픽이 가파르게 증가하면 현재 서버들로 트래픽을 감당할 수 없는 시점이 오는데, 이 때 로드밸런서는 단순히 더 많은 서버를 추가하면 된다. 그러면 자동으로 트래픽이 분산된다.

이와 같은 과정을 통해 수평적 규모 확장을 구현할 수 있다. 이제 장애를 자동 복구하지 못하는 문제는 해소되고, 웹 계층의 가용성은 향상된다.

이제 웹 계층은 괜찮아 보이는데 데이터 계층은 어떨까? 역시 데이터베이스 서버는 하나 뿐이고 이것이 다운되면 데이터베이스 계층은 완전히 중단된다.

데이터베이스 다중화는 이런 문제를 해결하는 보편적인 기술이다.


**데이터베이스 다중화**

데이터베이스 다중화는 데이터베이스 서버를 여러 대 두는 것을 말한다. 보통은 서버 사이에 주(master)-부(slave) 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장한다. 

주 데이터베이스는 쓰기 연산을 지원하고, 부 서버는 주 데이터베이스로부터 사본을 전달받고, 읽기 연산만을 지원한다.

대부분의 애플리케이션은 읽기 연산이 쓰기 연산보다 훨씬 많기 때문에 보통 부 데이터베이스의 수가 주 데이터베이스의 수보다 많다. 

데이터베이스 다중화는 다음과 같은 이득이 있다.
- 모든 쓰기 연산은 주 데이터베이스로만 전달되는 반면 읽기 연산은 부 데이터베이스 서버들로 분산된다. 병렬로 처리될 수 있는 질의의 수가 증가하므로 성능이 좋아진다.
- 데이터를 여러 지역에 복제해 둠으로써, 하나의 데이터베이스에서 장애가 발생하더라도 다른 지역에 있는 데이터베이스로 데이터를 복구할 수 있다.

데이터베이스 가운데 하나가 다운되면 구체적으로 다음과 같은 일이 일어난다.
- 부 서버가 한 대 뿐인데 다운 되었다면, 주 서버는 자동으로 부 서버를 대신 해 읽기 연산을 처리한다. 부 서버가 여러 대인 경우엔 읽기 연산은 나머지 부 서버들에게 분산된다.
- 주 서버가 다운되면 부 서버들 중 하나가 주 서버로 승격되어 쓰기 연산을 처리하고 다른 부 서버들은 새로운 주 서버로부터 사본을 전달받는다. 이 때 부 서버에 보관된 데이터가 최신 상태가 아닐 수도 있는데, 없는 데이터는 복구 스크립트를 돌려서 추가해야 한다.


로드벨런서와 데이터베이스 다중화를 고려한 설계안은 다음과 같이 동작한다.
- 사용자는 DNS 서버를 통해 로드밸런서의 IP 주소를 얻는다.
- 사용자는 해당 IP 주소로 로드밸런서에 접속한다.
- HTTP 요청은 부하 분산 집합에 속한 웹 서버들에게 분산된다.
- 웹 서버는 사용자의 데이터를 부 데이터베이스에서 읽는다.
- 쓰기 연산은 주 데이터베이스에 전달된다.


이제 웹 계층과 데이터 계층 모두 장애를 자동 복구하고 확장성을 개선할 수 있게 되었다. 

이제 응답 시간을 개선하기 위해 캐시와 CDN을 도입해 보자.


### 캐시

캐시는 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리에 두고, 다음 요청이 보다 빨리 처리되도록 하는 저장소다. 

이전 설계에선 요청을 할 때 마다 한 번 이상의 데이터베이스 호출이 발생한다. 애플리케이션의 성능은 데이터베이스를 얼마나 자주 호출하느냐에 크게 좌우되는데, 캐시는 그런 문제를 완화한다.

캐시 계층을 두면 구체적으로 다음과 같은 일이 일어난다.
1. 요청을 받은 웹 서버는 캐시에 응답이 저장되어 있는지 확인한다.
2. 캐시에 응답이 저장되어 있으면 캐시에서 바로 응답을 반환한다.
3. 캐시에 응답이 없으면 데이터베이스에 질의하여 데이터를 찾아 캐시에 저장한 뒤 클라이언트에 반환한다.

캐시를 사용할 땐 몇 가지 주의할 점이 있다.
- 캐시는 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어날 때 고려할만하다.
- 캐시는 휘발성 메모리이기 때문에 영구적으로 보관할 데이터를 캐시에 저장하면 안 된다.
- 캐시 만료 정책을 정하고 캐시를 관리해야 한다. 만료 기간이 짧다면 데이터베이스에 부하가 많이 가고, 만료 기간이 길다면 데이터가 최신이 아닐 수도 있다.
- 데이터베이스의 원본과 캐시 사이에 일관성 문제가 발생할 수 있다. 이를 해결하기 위해 데이터베이스와 캐시 사이에 일관성 전략을 정하고 캐시를 관리해야 한다.
- 캐시가 꽉 차면 기존 데이터를 삭제해야 하는데, 이 때 어떤 데이터를 삭제할지 결정하는 정책을 정하고 캐시를 관리해야 한다. 주로 LRU 알고리즘을 사용한다.


### CDN

CDN은 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크이다. 이미지, 비디오, CSS, JavaScript 파일 등을 캐시할 수 있다.

CDN을 사용하면 구체적으로 다음과 같은 일이 일어난다.
1. 사용자는 이미지 URL을 통해 이미지를 요청한다. URL 의 도메인은 CDN 서비스 사업자가 제공한 것이다.
2. CDN 서버의 캐시에 이미지가 있으면 캐시에서 이미지를 반환한다.
3. 캐시에 이미지가 없으면 원본 서버에 이미지를 요청한다.
4. 원본 서버는 이미지를 반환하는데 이 때 응답엔 이미지의 유효 기간을 나타내는 TTL 헤더가 있다.
5. 캐시는 이 헤더를 통해 이미지가 유효한 기간을 알 수 있고, 이 기간 동안 캐시에 이미지를 저장한다.

CDN을 사용힐 때 주의할 점은 다음과 같다.
- CDN 은 보통 제 3자가 제공하는 서비스이기 때문에 비용이 발생한다.
- 만료 시한을 적절하게 설정해야 한다.


캐시와 CDN을 추가해 다음과 같은 이득이 있다.
- 정적 콘텐츠는 더 이상 웹 서버를 통해 서비스 하지 않는다. CDN 을 통해 더 나은 성능을 보장한다.
- 캐시는 데이터베이스 부하를 줄여준다.



### 무상태 웹 계층
웹 계층을 수평적으로 확장하려면 상태 정보를 웹 계층에서 제거하여야 한다.


**상태 정보 의존적인 아키텍처**

상태 정보를 보관하는 서버는 클라이언트 정보, 즉 상태를 유지해 요청들 사이에 공유되도록 한다.

사용자 A 의 상태 정보가 서버 1에 저장되었다면, 사용자 A 를 인증하기 위해 요청은 반드시 서버 1로 전송되어야 한다. 다른 서버엔 사용자 A 의 상태 정보가 없기 때문이다.

같은 클라이언트로부터의 요청은 항상 같은 서버로 전송되어야 한다는 것인데, 이것을 보장하는 것은 까다롭다.

**무상태 아키텍처**

무상태 아키텍처는 상태 정보를 서버에 저장하지 않는다. 웹 서버는 상태 정보가 필요할 경우 공유 저장소로부터 데이터를 가져온다. 따라서 사용자의 요청이 아무 웹 서버로도 전달될 수 있다. 

세션 데이터를 웹 계층에서 분리하고 지속성 데이터 보관소에 저장하도록 만들 수 있다. 이 저장소는 보통 NoSQL 을 사용하는데, 규모 확장이 간편해서다.


### 데이터 센터

지리적으로 분산된 여러개의 데이터 센터를 두고 사용자의 위치에 따라 적절한 데이터 센터에 접속하도록 만드는 것이다.

데이터 센터는 몇 가지 기술적 난제를 해결해야 한다.
- 올바른 데이터 센터로 트래픽을 전달해야 한다.
- 데이터 센터 간 데이터 동기화를 보장해야 한다.
- 모든 데이터 센터에 동일한 서비스가 설치되도록 자동화된 배포 프로세스가 필요하다.

시스템을 더 큰 규모로 확장하기 위해서는 시스템의 컴포넌트를 분리하여, 각기 독립적으로 확장될 수 있도록 하여야 한다.

메시지 큐는 이런 문제를 해결하는 데 도움이 된다.


### 메시지 큐

메시지 큐는 메시지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트다.

메시지 큐의 기본 아키텍처는 간단하다. 생산자는 메시지를 큐에 보내고, 소비자는 큐에서 메시지를 가져온다.

메시지 큐를 이용하면 서비스 간 결합이 느슨해져서, 규모 확장성이 보장되어야 하는 안정적인 시스템을 만들 수 있다. 생산자는 소비자가 다운되어 있어도 메시지를 보낼 수 있고, 소비자는 생산자가 다운되어 있어도 메시지를 받을 수 있다.


### 로그, 메트릭 그리고 자동화

작은 서비스엔 꼭 필요없지만 사업 규모가 커지면 로그, 메트릭, 자동화 등의 기능에 필수적으로 투자해야 한다.

- 로그: 에러 로그를 모니터링 하는 것은 중요하다. 로그를 단일 서비스로 모아주는 도구를 활용하면 좋다.
- 메트릭: 메트릭을 잘 수집하면 유용한 정보를 얻을 수 있다. 
    - CPU, 메모리, 디스크 사용량 같은 하드웨어 메트릭
    - 일별 능동 사용자, 수익 같은 비즈니스 메트릭
- 자동화: 시스템이 크고 복잡해지면 자동화가 필수적이다. 가령 지속적 통합, 지속적 배포, 지속적 모니터링 등을 통해 개발 생산성을 향상시킬 수 있다.


### 데이터베이스 규모 확장

데이터베이스도 웹 서버와 같이 수직적 확장과 수평적 확장을 할 수 있다.

하지만 수직적 확장은 같은 문제가 있다.

데이터베이스의 수평적 확장은 샤딩이라고도 부르는데, 이는 대규모 데이터베이스를 샤드라고 부르는 작은 단위로 나누는 것을 말한다. 

모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.
가령 사용자 데이터를 보관할 때, `user_id%4` 를 해시 함수로 사용해 데이터가 보관되는 샤드를 정할 수 있다.

샤딩을 통해 데이터베이스를 효과적으로 분할하고 확장할 수 있지만 몇 가지 문제가 있다.
- 데이터의 재 샤딩이 필요할 수 있다. 가령 데이터가 너무 많아서 하나의 샤드로는 감당하기 어렵거나, 샤드 간 데이터 분포가 균등하지 못하는 경우가 있다.
- 유명인사 문제가 있다. 특정 샤드에 질의가 집중되는 것이다. 가령 케이티 페리, 저스틴 비버 같은 유명인사가 전부 같은 샤드에 저장된다면 그 샤드는 결국 과부가가 걸리게 될 것이다.
- 일단 하나의 데이터베이스를 여러 샤드 서버로 쪼개고 나면, 여러 샤드에 걸친 데이터를 조인하기가 힘들어진다. 이 때는 데이터베이스를 비정규화 하여 해결할 수 있다.


### 백만 사용자, 그리고 그 이상

시스템의 규모를 확장하는 것은 지속적이고 반복적인 과정이다. 수백만 사용자 이상을 지원하려면 새로운 전략을 도입해 지속적으로 시스템을 가다듬어야 한다.

이번 장에서 살펴본 기법을 정리하면 다음과 같다.
- 웹 계층은 무상태로
- 모든 계층에 다중화를!
- 캐시는 가능한 많이
- 여러 데이터 센터!
- 정적 콘텐츠는 CDN 으로
- 샤딩을 통해 데이터 계층 규모 확장
- 각 계층은 독립적으로!
- 지속적으로 모니터링하고, 자동화하라!